{{extend 'layout.html'}}

<div id="target"></div>
<script id="template" type="text/ractive">
    <!-- Banner alert if the user has no devices. It asks them to register a new device. -->
    {% #unless loading %}
        {{if len(device_list) == 0:}}
            <div class="alert alert-warning alert-dismissible" role="alert" align="center">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <a href={{=URL('default', 'add')}}>Hey! Looks like you haven't added any devices to your account, do that first.</a>
            </div>
        {{pass}}
    {% /unless %}

    <div id="left_sidebar" class="col-md-3">
        {% #unless loading %}
            <h2 align="center">Devices</h2><br/>
            <div class="list-group" align="center">
                <!-- Drill it into their minds that they NEED to add a device -->
                {{if len(device_list) == 0:}}
                    <a href="{{=URL('default', 'add')}}" class="list-group-item active">Add a new device?</a>
                <!-- Otherwise here we just list the device names -->
                {{else:}}
                    {% #each device_dict:device_id %}
                        <a href="#" on-click="set_val:{% device_id %}" class="list-group-item">{% name %}</a>
                    {% /each %}
                {{pass}}
            </div>
        {% /unless %}
    </div>

    <!-- This where the charts and logs from the data viz team would go
          For now, we're just fine with leaving a loading animation in here. -->
    <div id="middle_bar" class="col-md-6" align="center">
        {% #if loading %}
            <div id="load_spinner" class="centered">
                <div class="showbox">
                  <div class="loader">
                    <svg class="circular" viewBox="25 25 50 50">
                      <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
                    </svg>
                  </div>
                </div>
            </div>
        {% /if %}
    </div>

    <!-- Things here are mostly still a WIP except for the delete button -->
    {% #unless loading %}
        <div id="device_info" class="col-md-3" align="center">
            <h2>Configuration</h2><br/>
            <!-- This would link to something produced by the script editor team -->
            <button type="button" class="btn btn-primary" href="{{=URL('default', 'manage')}}">Manage Procedures</button>
            <button type="button" class="btn btn-danger" on-click="delete:{% selection_value %}">Delete Device</button><br><br>
            <ul class="list-group">
                <li class="list-group-item"><span class="badge"><i class="fa fa-check" aria-hidden="true"></i></span>Status: OK</li>
                <li class="list-group-item">Last synced: </li>
                <li class="list-group-item">Next sync in: </li>
            </ul>
        </div>
    {% /unless %}
</script>

<script>
$(function() {
    // Ractive object
    var ractive = new Ractive({
        el: '#target',
        template: '#template',
        delimiters: ['{%', '%}'],
        tripleDelimiters: ['{%%', '%%}'],
        data: {
            device_dict: {},
            delete_devices: [],
            loading: true,
            sign_uuid: "{{=sign_uuid}}",
            selection_value: -1
        }
    });

    // Refreshes device list every time function is called
    function load_devices(){
        $.ajax("{{=URL('default', 'load_devices', user_signature=True, args=sign_uuid)}}",
                {
                    method: 'POST',
                    success: function (data) {
                        ractive.set('device_dict', data['device_dict']);
                        ractive.set('loading', false);
                    }
                }
        );
    }

    // Call load_devices() initially when the page first loads
    load_devices();

    ractive.on("set_val", function(e, value){
        ractive.set('selection_value', value)
    });

    // Delete logic
    ractive.on("delete", function(e, device_id){
        if(device_id == -1){
            alert("You are trying to delete with no selection.");
            return;
        }
        var delete_devices = ractive.get('delete_devices');
        if(delete_devices.indexOf(device_id) == -1) delete_devices.push(device_id);
        else delete_devices.pop(device_id);
        ractive.set('delete_list', delete_devices);
        $.ajax("{{=URL('default', 'delete_devices', user_signature=True)}}",
                {
                    data: { delete_devices: delete_devices },
                    method: 'POST',
                    success: function() {},
                    error: function() {}
                }
        );
        ractive.set('delete_list', []);
        load_devices();
    });
});
</script>